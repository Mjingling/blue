{include file="public/header" /}
<link rel="stylesheet" type="text/css" href="{$__RESOURCE__}styles/schedules_preview.css">
<link rel="stylesheet" type="text/css" href="{$__RESOURCE__}styles/stores.css">
<div class="app-body">

<div class="flow">
    <i class="icon-number2"></i><strong>选择档期</strong> <span>(开放14天内的档期) <span class="can-book">可预约</span> <span class="fully">已约满</span></span>
</div>

<div class="schedules-preview clearfix">
    <div id="schedule-date-swiper" style="margin-bottom: 14px">
        <div class="swiper-container swiper-container-horizontal">
            <div class="swiper-wrapper" style="transition-duration: 0ms; transform: translate3d(-268.8px, 0px, 0px);">


                                <div data-date="2017-03-23" class="swiper-slide schedule-item disable" style="width: 125.4px; margin-right: 9px;">
                    <div class="schedule-date">
                        <span class="month">3月</span>
                        <strong class="day">23</strong>
                    </div>
                    <div class="schedule-weekly">
                                                今天
                                            </div>
                    <div class="schedule-status"></div>
                </div>


                                <div data-date="2017-03-24" class="swiper-slide schedule-item disable swiper-slide-prev" style="width: 125.4px; margin-right: 9px;">
                    <div class="schedule-date">
                        <span class="month">3月</span>
                        <strong class="day">24</strong>
                    </div>
                    <div class="schedule-weekly">
                                                周五
                                            </div>
                    <div class="schedule-status"></div>
                </div>


                                <div data-date="2017-03-25" class="swiper-slide schedule-item disable swiper-slide-active" style="width: 125.4px; margin-right: 9px;">
                    <div class="schedule-date">
                        <span class="month">3月</span>
                        <strong class="day">25</strong>
                    </div>
                    <div class="schedule-weekly">
                                                周六
                                            </div>
                    <div class="schedule-status"></div>
                </div>


                                <div data-date="2017-03-26" class="swiper-slide schedule-item disable swiper-slide-next" style="width: 125.4px; margin-right: 9px;">
                    <div class="schedule-date">
                        <span class="month">3月</span>
                        <strong class="day">26</strong>
                    </div>
                    <div class="schedule-weekly">
                                                周日
                                            </div>
                    <div class="schedule-status"></div>
                </div>


                                <div data-date="2017-03-27" class="swiper-slide schedule-item" style="width: 125.4px; margin-right: 9px;">
                    <div class="schedule-date">
                        <span class="month">3月</span>
                        <strong class="day">27</strong>
                    </div>
                    <div class="schedule-weekly">
                                                周一
                                            </div>
                    <div class="schedule-status"></div>
                </div>


                                <div data-date="2017-03-28" class="swiper-slide schedule-item disable" style="width: 125.4px; margin-right: 9px;">
                    <div class="schedule-date">
                        <span class="month">3月</span>
                        <strong class="day">28</strong>
                    </div>
                    <div class="schedule-weekly">
                                                周二
                                            </div>
                    <div class="schedule-status"></div>
                </div>


                                <div data-date="2017-03-29" class="swiper-slide schedule-item disable" style="width: 125.4px; margin-right: 9px;">
                    <div class="schedule-date">
                        <span class="month">3月</span>
                        <strong class="day">29</strong>
                    </div>
                    <div class="schedule-weekly">
                                                周三
                                            </div>
                    <div class="schedule-status"></div>
                </div>


                                <div data-date="2017-03-30" class="swiper-slide schedule-item disable" style="width: 125.4px; margin-right: 9px;">
                    <div class="schedule-date">
                        <span class="month">3月</span>
                        <strong class="day">30</strong>
                    </div>
                    <div class="schedule-weekly">
                                                周四
                                            </div>
                    <div class="schedule-status"></div>
                </div>


                                <div data-date="2017-03-31" class="swiper-slide schedule-item disable" style="width: 125.4px; margin-right: 9px;">
                    <div class="schedule-date">
                        <span class="month">3月</span>
                        <strong class="day">31</strong>
                    </div>
                    <div class="schedule-weekly">
                                                周五
                                            </div>
                    <div class="schedule-status"></div>
                </div>


                                <div data-date="2017-04-01" class="swiper-slide schedule-item disable" style="width: 125.4px; margin-right: 9px;">
                    <div class="schedule-date">
                        <span class="month">4月</span>
                        <strong class="day">1</strong>
                    </div>
                    <div class="schedule-weekly">
                                                周六
                                            </div>
                    <div class="schedule-status"></div>
                </div>


                                <div data-date="2017-04-02" class="swiper-slide schedule-item disable" style="width: 125.4px; margin-right: 9px;">
                    <div class="schedule-date">
                        <span class="month">4月</span>
                        <strong class="day">2</strong>
                    </div>
                    <div class="schedule-weekly">
                                                周日
                                            </div>
                    <div class="schedule-status"></div>
                </div>


                                <div data-date="2017-04-03" class="swiper-slide schedule-item disable" style="width: 125.4px; margin-right: 9px;">
                    <div class="schedule-date">
                        <span class="month">4月</span>
                        <strong class="day">3</strong>
                    </div>
                    <div class="schedule-weekly">
                                                周一
                                            </div>
                    <div class="schedule-status"></div>
                </div>


                                <div data-date="2017-04-04" class="swiper-slide schedule-item disable" style="width: 125.4px; margin-right: 9px;">
                    <div class="schedule-date">
                        <span class="month">4月</span>
                        <strong class="day">4</strong>
                    </div>
                    <div class="schedule-weekly">
                                                周二
                                            </div>
                    <div class="schedule-status"></div>
                </div>


                                <div data-date="2017-04-05" class="swiper-slide schedule-item disable" style="width: 125.4px; margin-right: 9px;">
                    <div class="schedule-date">
                        <span class="month">4月</span>
                        <strong class="day">5</strong>
                    </div>
                    <div class="schedule-weekly">
                                                周三
                                            </div>
                    <div class="schedule-status"></div>
                </div>


                                <div data-date="2017-04-06" class="swiper-slide schedule-item disable" style="width: 125.4px; margin-right: 9px;">
                    <div class="schedule-date">
                        <span class="month">4月</span>
                        <strong class="day">6</strong>
                    </div>
                    <div class="schedule-weekly">
                                                周四
                                            </div>
                    <div class="schedule-status"></div>
                </div>

                            </div>
        </div>
        <a href="javascript:;" class="swiper-prev icon-arrow-left"></a>
        <a href="javascript:;" class="swiper-next icon-arrow-right"></a>
    </div>
    <div class="schedule-selected">
        <dl>
            <dt>已选择档期</dt>
            <dd id="schedule-selected">2017年3月23日(周四)</dd>
        </dl>
        <a id="all-schedules" href="javascript:void(0);" class="all-schedules icon-calender">全部档期</a>
    </div>
</div>
<div class="flow"><i class="icon-number3"></i><strong>选择门店</strong></div>

<div id="loadingBox" class="clearfix" style="text-align:center;display:none;background-color: #f6f6f6;">
    <br><br><br><br>
    <span id="loadingText">加载中</span>
    <br><br><br>
    <br><br>
</div>
<div id="store-box" class="store-box">
    <ul class="store-list">
                    <li data-store="1" data-city="上海" data-storeid="1" data-productid="14" class="disable">
                <a href="javascript:;">
                    <div class="status"><i class="can-book"></i><i class="icon-success-fill"></i><i class="icon-full"></i></div>
                    <div class="store-name"><span><strong>上海五角场店</strong></span></div>
                    <div class="store-address-tel">
                        <div class="store-address">上海市杨浦区淞沪路234号创智天地101</div>
                    </div>
                    <!-- <a href="/book/remind?city=上海&productId=14&storeId=1"  class="remind"><i class="icon-remind"></i>档期提醒</a>
                    <div class="arrow"><i class="icon-arrow-right"></i></div> -->
                </a>
            </li>
                    <li data-store="2" data-city="上海" data-storeid="2" data-productid="14" class="disable">
                <a href="javascript:;">
                    <div class="status"><i class="can-book"></i><i class="icon-success-fill"></i><i class="icon-full"></i></div>
                    <div class="store-name"><span><strong>上海虹口店</strong></span></div>
                    <div class="store-address-tel">
                        <div class="store-address">上海市虹口区哈尔滨路159号</div>
                    </div>
                    <!-- <a href="/book/remind?city=上海&productId=14&storeId=2"  class="remind"><i class="icon-remind"></i>档期提醒</a>
                    <div class="arrow"><i class="icon-arrow-right"></i></div> -->
                </a>
            </li>
            </ul>
</div>

<div id="schedules-calender-open" class="schedules-calender-open schedules-calender-open-show">
    <ul class="clearfix">

        <li data-date="2017-03-23" class="schedule-item disable" style="width: 127.4px;">
            <div class="schedule-date">
                <span class="month">3月</span>
                <strong class="day">23</strong>
            </div>
            <div class="schedule-weekly">
                                今天
                            </div>
            <div class="schedule-status"></div>
        </li>

        <li data-date="2017-03-24" class="schedule-item disable" style="width: 127.4px;">
            <div class="schedule-date">
                <span class="month">3月</span>
                <strong class="day">24</strong>
            </div>
            <div class="schedule-weekly">
                                周五
                            </div>
            <div class="schedule-status"></div>
        </li>

        <li data-date="2017-03-25" class="schedule-item disable" style="width: 127.4px;">
            <div class="schedule-date">
                <span class="month">3月</span>
                <strong class="day">25</strong>
            </div>
            <div class="schedule-weekly">
                                周六
                            </div>
            <div class="schedule-status"></div>
        </li>

        <li data-date="2017-03-26" class="schedule-item disable" style="width: 127.4px;">
            <div class="schedule-date">
                <span class="month">3月</span>
                <strong class="day">26</strong>
            </div>
            <div class="schedule-weekly">
                                周日
                            </div>
            <div class="schedule-status"></div>
        </li>

        <li data-date="2017-03-27" class="schedule-item disable" style="width: 127.4px;">
            <div class="schedule-date">
                <span class="month">3月</span>
                <strong class="day">27</strong>
            </div>
            <div class="schedule-weekly">
                                周一
                            </div>
            <div class="schedule-status"></div>
        </li>

        <li data-date="2017-03-28" class="schedule-item disable" style="width: 127.4px;">
            <div class="schedule-date">
                <span class="month">3月</span>
                <strong class="day">28</strong>
            </div>
            <div class="schedule-weekly">
                                周二
                            </div>
            <div class="schedule-status"></div>
        </li>

        <li data-date="2017-03-29" class="schedule-item disable" style="width: 127.4px;">
            <div class="schedule-date">
                <span class="month">3月</span>
                <strong class="day">29</strong>
            </div>
            <div class="schedule-weekly">
                                周三
                            </div>
            <div class="schedule-status"></div>
        </li>

        <li data-date="2017-03-30" class="schedule-item disable" style="width: 127.4px;">
            <div class="schedule-date">
                <span class="month">3月</span>
                <strong class="day">30</strong>
            </div>
            <div class="schedule-weekly">
                                周四
                            </div>
            <div class="schedule-status"></div>
        </li>

        <li data-date="2017-03-31" class="schedule-item disable" style="width: 127.4px;">
            <div class="schedule-date">
                <span class="month">3月</span>
                <strong class="day">31</strong>
            </div>
            <div class="schedule-weekly">
                                周五
                            </div>
            <div class="schedule-status"></div>
        </li>

        <li data-date="2017-04-01" class="schedule-item disable" style="width: 127.4px;">
            <div class="schedule-date">
                <span class="month">4月</span>
                <strong class="day">1</strong>
            </div>
            <div class="schedule-weekly">
                                周六
                            </div>
            <div class="schedule-status"></div>
        </li>

        <li data-date="2017-04-02" class="schedule-item disable" style="width: 127.4px;">
            <div class="schedule-date">
                <span class="month">4月</span>
                <strong class="day">2</strong>
            </div>
            <div class="schedule-weekly">
                                周日
                            </div>
            <div class="schedule-status"></div>
        </li>

        <li data-date="2017-04-03" class="schedule-item disable" style="width: 127.4px;">
            <div class="schedule-date">
                <span class="month">4月</span>
                <strong class="day">3</strong>
            </div>
            <div class="schedule-weekly">
                                周一
                            </div>
            <div class="schedule-status"></div>
        </li>

        <li data-date="2017-04-04" class="schedule-item disable" style="width: 127.4px;">
            <div class="schedule-date">
                <span class="month">4月</span>
                <strong class="day">4</strong>
            </div>
            <div class="schedule-weekly">
                                周二
                            </div>
            <div class="schedule-status"></div>
        </li>

        <li data-date="2017-04-05" class="schedule-item disable" style="width: 127.4px;">
            <div class="schedule-date">
                <span class="month">4月</span>
                <strong class="day">5</strong>
            </div>
            <div class="schedule-weekly">
                                周三
                            </div>
            <div class="schedule-status"></div>
        </li>

        <li data-date="2017-04-06" class="schedule-item disable" style="width: 127.4px;">
            <div class="schedule-date">
                <span class="month">4月</span>
                <strong class="day">6</strong>
            </div>
            <div class="schedule-weekly">
                                周四
                            </div>
            <div class="schedule-status"></div>
        </li>
                    </ul>

        <div class="schedules-calender-open-action">
        <p>可预约14天内的档期，新一天的档期于每日10:00开放。</p>
        <!-- <a href="/book/remind?city=上海&productId=14">档期提醒</a> -->
    </div>
    </div>

        <div id="page-mask" class="page-mask"></div>
    </div>

    <script type="text/javascript">
    var selectDate = '2017-03-23';
    var activied = '';
    var scheduleDates = {"latest":"","dateList":[{"date":1490198400,"canOrder":false,"hasSchedule":false,"week":"\u56db"},{"date":1490284800,"canOrder":true,"hasSchedule":false,"week":"\u4e94"},{"date":1490371200,"canOrder":true,"hasSchedule":false,"week":"\u516d"},{"date":1490457600,"canOrder":true,"hasSchedule":false,"week":"\u65e5"},{"date":1490544000,"canOrder":true,"hasSchedule":false,"week":"\u4e00"},{"date":1490630400,"canOrder":true,"hasSchedule":false,"week":"\u4e8c"},{"date":1490716800,"canOrder":true,"hasSchedule":false,"week":"\u4e09"},{"date":1490803200,"canOrder":true,"hasSchedule":false,"week":"\u56db"},{"date":1490889600,"canOrder":true,"hasSchedule":false,"week":"\u4e94"},{"date":1490976000,"canOrder":true,"hasSchedule":false,"week":"\u516d"},{"date":1491062400,"canOrder":true,"hasSchedule":false,"week":"\u65e5"},{"date":1491148800,"canOrder":true,"hasSchedule":false,"week":"\u4e00"},{"date":1491235200,"canOrder":true,"hasSchedule":false,"week":"\u4e8c"},{"date":1491321600,"canOrder":true,"hasSchedule":false,"week":"\u4e09"},{"date":1491408000,"canOrder":true,"hasSchedule":false,"week":"\u56db"}]};
    var weekAry = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
    var city = '上海';
    var tag = 'default';

    var productId = '14';
    var initSlideIndex = 1;
    (function(){
        var opw = $('#schedules-calender-open').width();
        var itemW = opw / 5 - 14;
        $('#schedules-calender-open li').width(itemW);
    })();
    if (activied) {
        $('#schedules-calender-open').removeClass('schedules-calender-open-show');
    }
    $('[data-role="schedule-date"]').each(function() {
        var d = $(this).attr('data-date');
        if(d == selectDate) {
            initSlideIndex = $(this).index();
        }
    });
    if (initSlideIndex < 2) {
        initSlideIndex = 2;
    }
    var mySwiper = new Swiper ('.swiper-container', {
        slidesPerView : 5,
        initialSlide: initSlideIndex,
        slidesPerGroup: 1,
        spaceBetween: 9,
        prevButton:'.swiper-prev',
        nextButton:'.swiper-next',
        buttonDisabledClass: 'swiper-disable'
    });

    var $loadingTimer;

    function startLoading()
    {
        // List of words to loop on
        var words = ['加载中...','加载中','加载中.', '加载中..'];

        // Index of the words array
        var index = 0;

        $loadingTimer=window.setInterval(function(){
          $('#loadingText').html(words[index]);
          // Increment the index modulo the length of words: 0, 1, 2, 0, 1, 2, etc
          index = (index+1) % words.length;
        }, 500);
    }

    startLoading();

    function ajaxGetStoreScheduleStatus(date) {
        $('#loadingBox').show();
        $('#store-box').hide();
        $.ajax({
            'url': '/api/book/cal-schedule-for-city-on-date',
            'data': {
                'city': city,
                'productId': productId,
                'date': date
            },
            'dataType': 'json',
            'success': function(o) {
                console.log(o);
                $('#store-box').show();
                $('#loadingBox').hide();
                for(var i = 0; i < o.length; i++) {
                    if(o[i].atLeastOneStoreOpen=='no')
                    {
                        clearInterval($loadingTimer);
                        $('#store-box').hide();
                        $('#loadingBox').show();
                        $('#loadingText').html("本日已被约满<br />请返回后，重新选择日期");
                        window.location.reload(true);
                        break;
                    }

                    var storeId = o[i].id;
                    var hasSchedules = o[i].hasSchedules;
                    if (hasSchedules) {
                        $('[data-store="' + storeId + '"]').removeClass('disable');
                    } else {
                        $('[data-store="' + storeId + '"]').addClass('disable');
                    }
                }

            }
        });
        setScheduleSelected(date);
    }

    function setScheduleSelected(date) {
        selectDate = date;
        var dd = new Date(date);
        var y = dd.getFullYear();
        var m = dd.getMonth() + 1;
        var d = dd.getDate();
        var w = weekAry[dd.getDay()];
        $('#schedule-selected').html(y+"年"+m+"月"+d+"日("+w+")");
    }

    setScheduleSelected(selectDate);


    $(document).on('click', '[data-role="schedule-date"]', function() {
        if ($(this).hasClass('disable')) {
            return;
        }
        var date = $(this).data('date');
        ajaxGetStoreScheduleStatus(date);
        $('[data-role="schedule-date"]').removeClass('activied');
        $('[data-date="'+date+'"]').addClass('activied');
        mySwiper.slideTo($(this).index());
        if($('#schedules-calender-open').hasClass('schedules-calender-open-show')) {
            $('#schedules-calender-open').removeClass('schedules-calender-open-show');
        }
    });



    $('#all-schedules').on('click', function() {
       $('#schedules-calender-open').toggleClass('schedules-calender-open-show');
    });

    $('.store-list').on('click', 'li', function() {
        if($(this).hasClass('disable')) {
            return;
        }
        window.location.href = '/book/schedules?city=' + city + '&storeId=' + $(this).data('storeid') + '&productId='+productId+'&tag='+tag+'&date=' + selectDate;
    });

    //ajaxGetStoreScheduleStatus(selectDate);


</script>
{include file="public/footer" /}
